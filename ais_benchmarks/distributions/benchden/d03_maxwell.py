import numpy as np
from ais_benchmarks.distributions import CDistribution


class BenchDenMaxwell(CDistribution):
    """
    A density part of the benchmark described in [Mildenberger, Thoralf, and Henrike Weinert. “The Benchden Package:
    Benchmark Densities for Nonparametric Density Estimation.” Journal of Statistical Software 46, no. 1 (March 7,
    2012): 1–14. https://doi.org/10.18637/jss.v046.i14.]

    3. Maxwell: The density is given by f(x) = x exp(− x^2/2 ) on [0, inf). Random variates are generated by inversion
    of the distribution function.
    """

    def __init__(self, params):
        """
        :param params: A dictionary containing the distribution parameters. Must define the following parameters:
                params["dims"]
        """
        params["dims"] = 1
        params["family"] = "exponential"
        params["type"] = "maxwell"
        params["likelihood_f"] = self.prob
        params["loglikelihood_f"] = self.log_prob
        params["mean"] = np.array([1])
        params["support"] = np.array([0, 4])
        super(self.__class__, self).__init__(params)

    def log_prob(self, samples):
        if len(samples.shape) == 1:
            samples = samples.reshape(1, self.dims, 1)
        elif len(samples.shape) == 2:
            samples = samples.reshape(len(samples), self.dims, 1)
        else:
            raise ValueError("Shape of samples does not match self.dims")

        res = np.zeros(len(samples))
        inliers = np.all(samples > 0, axis=1).flatten()
        samples_in = samples[inliers]
        res_in = np.log(samples_in) - ((samples_in * samples_in) / 2)
        res_in = np.sum(res_in, axis=1)
        res[inliers] = res_in.flatten()
        return res

    def prob(self, samples):
        res = np.zeros(len(samples))
        inliers = np.all(samples > 0, axis=1).flatten()
        res[inliers] = np.exp(self.log_prob(samples[inliers]).flatten())
        return res

    def condition(self, dist):
        raise NotImplementedError

    def marginal(self, dim):
        raise NotImplementedError


if __name__ == "__main__":
    from matplotlib import pyplot as plt

    mean = np.array([1.])
    dist = BenchDenMaxwell(dict())

    plt.figure()
    plt.title('BenchDenMaxwell')
    dist.draw(plt.gca())
    plt.show()
